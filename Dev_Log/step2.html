<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TelpCamp プロジェクト作成の記録 - Step 2</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }

        h1,
        h2,
        h3 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        code {
            background-color: #ecf0f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        }

        pre {
            background-color: #2c3e50;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }

        pre code {
            background-color: transparent;
            padding: 0;
        }

        .step {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .concept {
            background-color: #e8f6f3;
            border-left: 5px solid #1abc9c;
            padding: 15px;
            margin: 20px 0;
        }

        li {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

    <h1>TelpCamp プロジェクト作成の記録</h1>

    <div class="step">
        <h2>学習の目的</h2>
        <p>
            このステップでは、CRUD (Create, Read, Update, Delete) のうち、<strong>R (Read)</strong> にあたる「一覧表示機能」を実装します。
            MongoDBに保存されているデータを取得し、Webページ上に動的に表示する流れを学びます。
        </p>
        <ul>
            <li>開発を効率化するための初期データ（Seedデータ）の投入方法を理解する。</li>
            <li>Expressのルーティングを使い、特定のURLへのリクエストを処理する方法を学ぶ。</li>
            <li>Mongooseの<code>find</code>メソッドを使い、データベースから複数のデータを取得する方法を習得する。</li>
            <li>サーバーサイド（Express）からクライアントサイド（EJS）へデータを渡し、EJSのループ構文を使って一覧表示する方法を理解する。</li>
        </ul>
    </div>

    <div class="step">
        <h2>ステップ2: 一覧表示 (Index) ページの作成</h2>
        <p>データベースにサンプルデータを投入し、そのデータを取得して一覧表示するページを作成します。</p>
        <ol>
            <li>
                <strong>初期データの準備 (<code>seeds/index.js</code>):</strong>
                <p>開発の初期段階で表示するデータがないと確認が難しいため、サンプルデータを投入するスクリプトを作成します。<code>seeds</code>フォルダを新規作成し、その中に<code>index.js</code>を作成します。
                </p>
                <pre><code>const mongoose = require('mongoose');
const Campground = require('../models/campground');

async function connectDB() {
  try {
    await mongoose.connect('mongodb://127.0.0.1:27017/telp-camp');
    console.log("MongoDBに接続しました。");
  } catch (err) {
    console.error("MongoDB接続エラー:", err);
  }
}

const seedDB = async () => {
    await connectDB();
    // 既存のキャンプ場データを全て削除
    await Campground.deleteMany({});
    // サンプルデータを定義
    const sampleCampgrounds = [
        { name: 'ふもとっぱら', location: '静岡県富士宮市', price: 3500, description: '富士山の麓に広がる広大なフリーサイト。絶景です。' },
        { name: '浩庵キャンプ場', location: '山梨県南巨摩郡', price: 6000, description: '本栖湖の湖畔にあり、千円札の裏の景色のモデルになった場所として有名。' },
        { name: '道志の森キャンプ場', location: '山梨県南都留郡', price: 4000, description: '川沿いに広がる自然豊かなキャンプ場。予約不要で人気。' }
    ];
    // サンプルデータをデータベースに一括で挿入
    await Campground.insertMany(sampleCampgrounds);
    console.log('初期データの投入に成功しました。');
};

// seedDB関数を実行し、完了したらデータベース接続を閉じる
seedDB().then(() => {
    mongoose.connection.close();
    console.log('MongoDBとの接続を閉じました。');
});</code></pre>
                <p>このスクリプトは、ターミナルで <code>node seeds/index.js</code> を実行することで、一度だけ実行します。</p>
                <div class="concept">
                    <h4>💡 Seedスクリプトの役割</h4>
                    <p><code>deleteMany({})</code>で既存のデータを一度空にしてから、<code>insertMany()</code>で新しいサンプルデータを投入しています。これにより、何度実行してもデータベースの状態を一定に保つことができます。
                    </p>
                </div>
            </li>
            <li>
                <strong>一覧表示ルートの追加 (<code>index.js</code>):</strong>
                <p><code>/campgrounds</code>というURLにGETリクエストが来たときに、データベースから全キャンプ場データを取得して一覧ページを表示する処理を追加します。</p>
                <pre><code>// キャンプ場一覧(Index)ページへのGETリクエスト
app.get('/campgrounds', async (req, res) => {
    // データベースから全てのキャンプ場データを取得します
    const campgrounds = await Campground.find({});
    // 取得したデータを 'campgrounds' という名前でビューに渡し、レンダリングします
    res.render('campgrounds/index', { campgrounds });
});</code></pre>
                <div class="concept">
                    <h4>💡 <code>Campground.find({})</code> とは？</h4>
                    <p>Mongooseのメソッドで、<code>Campground</code>モデルに対応するMongoDBコレクションからドキュメントを検索します。引数に空のオブジェクト
                        <code>{}</code> を渡すと、「条件なし」つまり全てのドキュメントを検索対象とします。この処理は非同期で行われるため、<code>await</code>で完了を待ちます。</p>
                </div>
            </li>
            <li>
                <strong>一覧表示ビューの作成 (<code>views/campgrounds/index.ejs</code>):</strong>
                <p>ルートから渡された<code>campgrounds</code>データ（配列）を元に、一覧を生成するEJSファイルを作成します。<code>views</code>フォルダ内に<code>campgrounds</code>フォルダを新規作成し、その中に<code>index.ejs</code>を作成します。
                </p>
                <pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;title&gt;キャンプ場一覧&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;すべてのキャンプ場&lt;/h1&gt;
    &lt;a href="/"&gt;トップページに戻る&lt;/a&gt;
    &lt;a href="/campgrounds/new"&gt;新しいキャンプ場を登録する&lt;/a&gt;

    &lt;ul&gt;
        &lt;% for (let campground of campgrounds) { %&gt;
            &lt;li&gt;
                &lt;a href="/campgrounds/&lt;%= campground._id %&gt;"&gt;
                    &lt;%= campground.name %&gt; - &lt;%= campground.location %&gt;
                &lt;/a&gt;
            &lt;/li&gt;
        &lt;% } %&gt;
    &lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                <div class="concept">
                    <h4>💡 EJSのループと出力</h4>
                    <ul>
                        <li><code>&lt;% for(...) { %&gt; ... &lt;% } %&gt;</code>:
                            <code>&lt;% %&gt;</code>で囲まれた部分はJavaScriptのコードとして実行されます。ここではfor...ofループを使い、渡された<code>campgrounds</code>配列の要素を一つずつ取り出しています。
                        </li>
                        <li><code>&lt;%= campground.name %&gt;</code>:
                            <code>&lt;%= %&gt;</code>で囲まれた部分は、その値がHTMLとして出力（エスケープ処理される）されます。</li>
                    </ul>
                </div>
            </li>
            <li>
                <strong>動作確認:</strong>
                <p>サーバーを再起動（<code>node index.js</code>）し、ブラウザで <code>http://localhost:3000/campgrounds</code>
                    にアクセスします。Seedスクリプトで投入した3つのキャンプ場がリスト表示されることを確認します。</p>
            </li>
        </ol>
    </div>

</body>

</html>