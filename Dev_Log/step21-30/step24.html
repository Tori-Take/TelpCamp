<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TelpCamp 開発記録 - Step 24: Express Routerによるルーティングの整理</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }

        h1,
        h2,
        h3,
        h4 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px
        }

        h4 {
            border-bottom: none;
            color: #3498db;
        }

        code {
            background-color: #ecf0f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        }

        pre {
            background-color: #2c3e50;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }

        pre code {
            background-color: transparent;
            padding: 0;
        }

        .step {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .concept {
            background-color: #eafaf1;
            border-left: 5px solid #2ecc71;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>

<body>

    <h1>TelpCamp プロジェクト作成の記録</h1>

    <div class="step">
        <h2>Step 24: Express Routerによるルーティングの整理（リファクタリング）</h2>
        <p>
            アプリケーションの機能が増えるにつれて、メインファイル（<code>index.js</code>）にすべてのルート定義が集中し、コードが長大化・複雑化していました。
            今回は、Expressの<code>Router</code>機能を使って、関連するルートを機能ごとに別のファイルに分割するリファクタリングを行いました。
        </p>

        <h3>学習の目的</h3>
        <ul>
            <li><code>express.Router</code>を使い、ルートをモジュール化する方法を学ぶ。</li>
            <li><code>app.use()</code>を使って、特定のパスプレフィックスを持つルートをルーターに接続する方法を理解する。</li>
            <li>ネストされたルートで親のパラメータ（例:
                <code>/campgrounds/:id</code>）を引き継ぐための<code>{ mergeParams: true }</code>オプションの役割を学ぶ。</li>
            <li>リファクタリングによってコードの可読性、保守性、拡張性が向上するメリットを体感する。</li>
        </ul>
    </div>

    <div class="step">
        <h2>実装の解説</h2>
        <p>
            これまで<code>index.js</code>に混在していた「キャンプ場」と「レビュー」のルートを、それぞれ専用のファイルに切り出します。
        </p>
        <ol>
            <li>
                <h4>1. ルーターファイルの作成</h4>
                <p>
                    まず、<code>routes</code>という新しいフォルダを作成します。その中に、キャンプ場用の<code>campgrounds.js</code>とレビュー用の<code>reviews.js</code>を作成します。
                </p>
                <p><strong><code>routes/campgrounds.js</code></strong></p>
                <pre><code class="language-javascript">const express = require('express');
const router = express.Router();
// ... 必要なモジュールとモデルを読み込む ...

// router.get('/', ...);
// router.post('/', ...);
// router.get('/:id', ...);
// ...

module.exports = router;</code></pre>
                <p>
                    <code>app.get</code>や<code>app.post</code>だった部分を<code>router.get</code>,
                    <code>router.post</code>に書き換え、最後に<code>module.exports = router;</code>でルーターをエクスポートします。
                </p>

                <p><strong><code>routes/reviews.js</code></strong></p>
                <pre><code class="language-javascript">const express = require('express');
// mergeParams: true が重要！
const router = express.Router({ mergeParams: true });
// ... 必要なモジュールとモデルを読み込む ...

// router.post('/', ...);
// router.delete('/:reviewId', ...);

module.exports = router;</code></pre>
                <div class="concept">
                    <h4>💡 <code>{ mergeParams: true }</code></h4>
                    <p>
                        レビューのルートは<code>/campgrounds/:id/reviews</code>のように、親のルート（キャンプ場）が持つパラメータ<code>:id</code>を必要とします。
                        デフォルトでは、子ルーター（<code>reviews.js</code>）は親ルーターのパラメータにアクセスできません。<code>{ mergeParams: true }</code>オプションを有効にすることで、<code>req.params.id</code>のように親のパラメータを受け取れるようになります。
                    </p>
                </div>
            </li>
            <li>
                <h4>2. メインファイル (<code>index.js</code>) の修正</h4>
                <p>
                    <code>index.js</code>から移動したルート定義をすべて削除し、代わりに作成したルーターファイルを読み込んで接続します。
                </p>
                <pre><code class="language-javascript">// index.js

// ルーターを読み込みます
const campgroundRoutes = require('./routes/campgrounds');
const reviewRoutes = require('./routes/reviews');

// ... Expressの設定 ...

// --- ルーティング ---
// ルーターを使用する
app.use('/campgrounds', campgroundRoutes);
app.use('/campgrounds/:id/reviews', reviewRoutes);

// トップページのルート
app.get('/', (req, res) => {
    res.render('home');
});

// ... エラーハンドリング ...
</code></pre>
                <p>
                    <code>app.use('/campgrounds', campgroundRoutes);</code>という記述は、「<code>/campgrounds</code>で始まるURLへのリクエストは、すべて<code>campgroundRoutes</code>に処理を任せる」という意味です。
                    ルーターファイル側ではパスのプレフィックス（<code>/campgrounds</code>）を省略できるため、コードがよりシンプルになります。
                </p>
            </li>
        </ol>
    </div>

    <div class="step">
        <h3>リファクタリングによるメリット</h3>
        <p>
            この変更により、<code>index.js</code>はアプリケーション全体の設定とルーターを束ねる「司令塔」としての役割に集中できるようになりました。
        </p>
        <ul>
            <li><strong>可読性の向上:</strong> ファイルの役割が明確になり、どこに何が書かれているか一目でわかるようになりました。</li>
            <li><strong>保守性の向上:</strong>
                キャンプ場に関する修正は<code>campgrounds.js</code>を、レビューに関する修正は<code>reviews.js</code>を見ればよくなり、修正箇所を特定しやすくなりました。
            </li>
            <li><strong>拡張性の向上:</strong>
                将来、ユーザー認証機能などを追加する場合も、<code>routes/users.js</code>を作成して<code>index.js</code>に1行追加するだけで済み、既存のコードへの影響を最小限に抑えられます。
            </li>
        </ul>
        <p>
            これは、アプリケーションが成長するにつれて非常に重要になる「関心の分離」という原則を実践した良い例です。
        </p>
    </div>

</body>

</html>