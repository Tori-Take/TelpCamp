<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TelpCamp プロジェクト作成の記録 - Step 4</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }

        h1,
        h2,
        h3 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        code {
            background-color: #ecf0f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        }

        pre {
            background-color: #2c3e50;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }

        pre code {
            background-color: transparent;
            padding: 0;
        }

        .step {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .concept {
            background-color: #e8f6f3;
            border-left: 5px solid #1abc9c;
            padding: 15px;
            margin: 20px 0;
        }

        li {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

    <h1>TelpCamp プロジェクト作成の記録</h1>

    <div class="step">
        <h2>学習の目的</h2>
        <p>
            このステップでは、CRUDの <strong>C (Create)</strong> にあたる「新規作成機能」を実装します。
            ユーザーがWebフォームを通じてデータを入力し、そのデータがデータベースに保存されるまでの一連の流れを学びます。
        </p>
        <ul>
            <li>フォームを表示するためのGETリクエストと、データを送信するためのPOSTリクエストの役割の違いを理解する。</li>
            <li>HTMLの<code>&lt;form&gt;</code>タグの<code>action</code>属性と<code>method</code>属性の使い方を学ぶ。</li>
            <li>ExpressでPOSTリクエストのデータ (<code>req.body</code>) を受け取る方法を習得する。</li>
            <li>Mongooseモデルの新しいインスタンスを作成し、<code>save()</code>メソッドでデータベースに保存する方法を理解する。</li>
            <li>処理完了後に別のページへユーザーを自動的に遷移させるリダイレクト (<code>res.redirect()</code>) の使い方を学ぶ。</li>
            <li><code>try...catch</code>を使った基本的なエラーハンドリングを実装する。</li>
        </ul>
    </div>

    <div class="step">
        <h2>ステップ4: 新規作成 (Create) 機能の実装</h2>
        <p>新しいキャンプ場を登録する機能は、大きく分けて「フォームを表示する」部分と「データを保存する」部分の2段階で実装します。</p>
        <ol>
            <li>
                <strong>新規登録フォーム表示ルートの追加 (<code>index.js</code>):</strong>
                <p><code>/campgrounds/new</code>というURLへのGETリクエストを処理するルートを追加します。このルートは、単純に登録フォームのHTML（<code>new.ejs</code>）をブラウザに返します。
                </p>
                <pre><code>// 新規登録(New)フォームページへのGETリクエスト
app.get('/campgrounds/new', (req, res) => {
    res.render('campgrounds/new');
});</code></pre>
                <div class="concept">
                    <h4>💡 ルートの定義順序に注意！</h4>
                    <p>この<code>app.get('/campgrounds/new', ...)</code>は、必ず<code>app.get('/campgrounds/:id', ...)</code>よりも<strong>前</strong>に記述する必要があります。もし順番が逆だと、Expressは<code>/campgrounds/new</code>というURLの<code>new</code>をIDだと誤解し、詳細ページ用のルートを呼び出そうとしてしまいます。Expressはルートを上から順にチェックするため、より具体的なパス（<code>/new</code>）を、より汎用的なパス（<code>/:id</code>）より先に定義することが重要です。
                    </p>
                </div>
            </li>
            <li>
                <strong>新規登録フォームのビューを作成 (<code>views/campgrounds/new.ejs</code>):</strong>
                <p>ユーザーが情報を入力するためのHTMLフォームを作成します。</p>
                <pre><code>&lt;form action="/campgrounds" method="POST"&gt;
    &lt;div&gt;
        &lt;label for="name"&gt;名前:&lt;/label&gt;
        &lt;input type="text" id="name" name="campground[name]" required&gt;
    &lt;/div&gt;
    ...
&lt;/form&gt;</code></pre>
                <div class="concept">
                    <h4>💡 <code>&lt;form&gt;</code>タグの重要属性</h4>
                    <ul>
                        <li><strong><code>action="/campgrounds"</code></strong>: フォームのデータをどこに送信するか（URL）を指定します。</li>
                        <li><strong><code>method="POST"</code></strong>:
                            データをどのようなHTTPメソッドで送信するかを指定します。<code>POST</code>は、新しいリソースを作成する際に使われる標準的なメソッドです。</li>
                    </ul>
                    <h4>💡 <code>name="campground[...]"</code> の意味</h4>
                    <p>各<code>&lt;input&gt;</code>の<code>name</code>属性を<code>campground[name]</code>や<code>campground[location]</code>のように設定することで、サーバー側では<code>req.body.campground</code>という名前のオブジェクトとして、フォームのデータをまとめて受け取ることができます。これにより、<code>new Campground(req.body.campground)</code>のように、受け取ったデータを直接モデルに渡すことができ、コードが非常に簡潔になります。
                    </p>
                </div>
            </li>
            <li>
                <strong>データ保存用ルートの追加 (<code>index.js</code>):</strong>
                <p>フォームから<code>POST</code>メソッドで<code>/campgrounds</code>に送信されたデータを受け取り、データベースに保存するためのルートを追加します。</p>
                <pre><code>// 新規登録(Create)処理のPOSTリクエスト
app.post('/campgrounds', async (req, res) => {
    try {
        const campground = new Campground(req.body.campground);
        await campground.save();
        res.redirect(`/campgrounds/${campground._id}`);
    } catch (e) {
        // ...エラー処理
    }
});</code></pre>
                <div class="concept">
                    <h4>💡 データの保存とリダイレクト</h4>
                    <ul>
                        <li><strong><code>new Campground(req.body.campground)</code></strong>:
                            フォームから送られてきたオブジェクトを元に、Mongooseモデルの新しいインスタンスを生成します。</li>
                        <li><strong><code>await campground.save()</code></strong>: 生成したインスタンスをデータベースに保存します。この処理は非同期です。
                        </li>
                        <li><strong><code>res.redirect(...)</code></strong>:
                            処理完了後、ブラウザを指定したURLに自動的に遷移させます。今回は、登録が成功したら、今作成したばかりのキャンプ場の詳細ページに移動させています。これにより、ユーザーは登録が成功したことを即座に確認できます。
                        </li>
                    </ul>
                </div>
            </li>
            <li>
                <strong>【改善】詳細表示ルートのエラーハンドリング:</strong>
                <p>今回の修正で、詳細表示ルートにも<code>try...catch</code>ブロックと、データが見つからなかった場合の処理を追加しました。これにより、不正なIDでアクセスされたり、データが存在しないIDでアクセスされたりしても、サーバーがクラッシュせず、適切なメッセージを返せるようになります。
                </p>
                <pre><code>app.get('/campgrounds/:id', async (req, res) => {
    try {
        const campground = await Campground.findById(req.params.id);
        if (!campground) {
            // データが見つからなかった場合の処理
            return res.status(404).send('...');
        }
        res.render('campgrounds/show', { campground });
    } catch (e) {
        // IDの形式が不正だった場合などの処理
        res.status(404).send('...');
    }
});</code></pre>
            </li>
        </ol>
    </div>

    <div class="step">
        <h2>動作確認</h2>
        <p>すべてのコードを書き終えたら、以下の手順で動作を確認します。</p>
        <ol>
            <li>ターミナルで一度サーバーを停止（<code>Ctrl + C</code>）し、再度<code>node index.js</code>コマンドで起動します。</li>
            <li>ブラウザでキャンプ場一覧ページ(<code>http://localhost:3000/campgrounds</code>)を開きます。</li>
            <li>一覧ページにある「新しいキャンプ場を登録する」のリンクをクリックし、登録フォーム(<code>http://localhost:3000/campgrounds/new</code>)が表示されることを確認します。
            </li>
            <li>フォームに新しいキャンプ場の情報を入力し、「登録する」ボタンを押します。</li>
            <li>新しく作成されたキャンプ場の詳細ページに自動で移動（リダイレクト）されれば成功です！</li>
            <li>「キャンプ場一覧へ戻る」リンクをクリックし、一覧に新しいキャンプ場が追加されていることも確認しましょう。</li>
        </ol>
    </div>

</body>

</html>