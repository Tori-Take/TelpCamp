<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TelpCamp 開発記録 - Step 40: 画像アップロード機能の実装</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }

        h1,
        h2,
        h3,
        h4 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px
        }

        h4 {
            border-bottom: none;
            color: #3498db;
        }

        code {
            background-color: #ecf0f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        }

        pre {
            background-color: #2c3e50;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }

        pre code {
            background-color: transparent;
            padding: 0;
        }

        .step {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .concept {
            background-color: #e8f6f3;
            border-left: 5px solid #1abc9c;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>

<body>

    <h1>TelpCamp プロジェクト作成の記録</h1>

    <div class="step">
        <h2>Step 40: 画像アップロード機能の実装 (Multer & Cloudinary)</h2>
        <p>
            これまでキャンプ場の画像は固定のURLをデータベースに保存していましたが、これをユーザーが実際に画像をアップロードできる機能に置き換えます。
            この実装には、ファイルアップロードを処理する<code>Multer</code>と、画像をクラウド上に保存・配信する<code>Cloudinary</code>という2つの強力なサービスを利用します。
        </p>
        <h3>学習の目的</h3>
        <ul>
            <li>フォームの<code>enctype="multipart/form-data"</code>の役割と、ファイルアップロードの仕組みを理解する。</li>
            <li><code>multer</code>ミドルウェアを使って、Expressでアップロードされたファイルを処理する方法を学ぶ。</li>
            <li><code>Cloudinary</code>のようなクラウドストレージサービスを利用して、画像を永続化し、URLとして管理する方法を習得する。</li>
            <li>APIキーなどの機密情報を<code>.env</code>ファイルで安全に管理する方法を実践する。</li>
            <li>複数の画像を扱えるように、モデルのスキーマを柔軟に設計する。</li>
        </ul>
    </div>

    <div class="step">
        <h2>実装の解説</h2>
        <p>
            設定からモデル、コントローラー、ビューまで、アプリケーション全体にわたる変更を行いました。
        </p>
        <ol>
            <li>
                <h4>1. 必要なパッケージのインストール</h4>
                <p>
                    ファイルアップロードとクラウド連携に必要なパッケージをインストールします。
                </p>
                <pre><code class="language-shell">npm install multer multer-storage-cloudinary cloudinary dotenv</code></pre>
            </li>
            <li>
                <h4>2. CloudinaryとMulterの設定</h4>
                <p>
                    まず、プロジェクトのルートに<code>.env</code>ファイルを作成し、CloudinaryのAPIキーなどの機密情報を記述します。
                </p>
                <pre><code class="language-text"># .env
CLOUDINARY_CLOUD_NAME=...
CLOUDINARY_KEY=...
CLOUDINARY_SECRET=...</code></pre>
                <p>
                    次に、これらの設定を読み込み、CloudinaryとMulterを連携させるための設定ファイル(<code>cloudinary/index.js</code>)を新しく作成します。
                </p>
                <pre><code class="language-javascript">// cloudinary/index.js
const cloudinary = require('cloudinary').v2;
const { CloudinaryStorage } = require('multer-storage-cloudinary');

cloudinary.config({
    cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
    api_key: process.env.CLOUDINARY_KEY,
    api_secret: process.env.CLOUDINARY_SECRET
});

const storage = new CloudinaryStorage({
    cloudinary,
    params: {
        folder: 'TelpCamp', // Cloudinary上の保存先フォルダ名
        allowedFormats: ['jpeg', 'png', 'jpg']
    }
});

module.exports = {
    cloudinary,
    storage
}</code></pre>
            </li>
            <li>
                <h4>3. Campgroundモデルの更新</h4>
                <p>
                    複数の画像を扱えるように、<code>image</code>フィールドを<code>images</code>という配列に変更しました。各画像はURLとファイル名を保持します。
                </p>
                <pre><code class="language-javascript">// models/campground.js
const campgroundSchema = new Schema({
    // ...
    images: [
        {
            url: String,
            filename: String
        }
    ],
    // ...
});</code></pre>
            </li>
            <li>
                <h4>4. フォームとルートの更新</h4>
                <p>
                    キャンプ場の新規登録・編集フォーム(<code>new.ejs</code>,
                    <code>edit.ejs</code>)に<code>enctype="multipart/form-data"</code>を追加し、画像選択用の<code>&lt;input type="file" multiple&gt;</code>を設置しました。
                </p>
                <p>
                    ルートファイル(<code>routes/campgrounds.js</code>)では、作成したMulterの設定をミドルウェアとして適用します。
                </p>
                <pre><code class="language-javascript">// routes/campgrounds.js
const multer = require('multer');
const { storage } = require('../cloudinary');
const upload = multer({ storage });

router.route('/')
    .post(isLoggedIn, upload.array('image'), validateCampground, wrapAsync(campgroundsController.createCampground));

router.route('/:id')
    .put(isLoggedIn, isAuthor, upload.array('image'), validateCampground, wrapAsync(campgroundsController.updateCampground));
</code></pre>
            </li>
            <li>
                <h4>5. コントローラーのロジック更新</h4>
                <p>
                    <code>createCampground</code>コントローラーで、アップロードされたファイル情報(<code>req.files</code>)を抽出し、データベースに保存するようにロジックを更新しました。
                </p>
                <pre><code class="language-javascript">// controllers/campgrounds.js
module.exports.createCampground = async (req, res, next) => {
    const campground = new Campground(req.body.campground);
    campground.images = req.files.map(f => ({ url: f.path, filename: f.filename }));
    campground.author = req.user._id;
    await campground.save();
    // ...
};</code></pre>
            </li>
            <li>
                <h4>6. 表示ビューの更新</h4>
                <p>
                    詳細ページ(<code>show.ejs</code>)で、アップロードされた画像を表示するためにBootstrapのカルーセルを導入しました。
                </p>
                <pre><code class="language-html">&lt;!-- show.ejs --&gt;
&lt;div id="campgroundCarousel" class="carousel slide"&gt;
  &lt;div class="carousel-inner"&gt;
    &lt;% campground.images.forEach((img, i) => { %&gt;
    &lt;div class="carousel-item &lt;%= i === 0 ? 'active' : '' %&gt;"&gt;
      &lt;img src="&lt;%= img.url %&gt;" class="d-block w-100" alt=""&gt;
    &lt;/div&gt;
    &lt;% }) %&gt;
  &lt;/div&gt;
  &lt;% if(campground.images.length > 1) { %&gt;
  &lt;!-- カルーセルのコントローラーボタン --&gt;
  &lt;% } %&gt;
&lt;/div&gt;</code></pre>
                <p>
                    この一連の実装により、ユーザーは自分の好きなキャンプ場の画像を投稿できるようになり、アプリケーションがよりダイナミックで魅力的なものになりました。
                </p>
            </li>
        </ol>
    </div>

</body>

</html>